<?php  error_reporting(0); $tpl_name = addslashes(trim($_POST['tpl_name'])); $email = addslashes(trim($_POST['email'])); $auth_code = addslashes(trim($_POST['auth_code'])); $posturl = addslashes(trim($_POST['posturl'])); $action = addslashes(trim($_POST['action'])); $renew = (int)$_POST['renew']; if($tpl_name){ include '../../includes/commons.inc.php'; }else{ define('PHPDISK_ROOT', '../../'); header("Content-Type: text/html; charset=utf-8"); if(!function_exists('make_dir')){ function make_dir($path,$write_file=1){ if(!is_dir($path)){ $str = dirname($path); if($str){ make_dir($str.'/'); @mkdir($path,0777); if($write_file){ file_put_contents($path.'index.htm','PHPDisk'); } } } } } if(!function_exists('gpc')){ function gpc($name,$w = 'GPC',$default = ''){ $i = 0; for($i = 0; $i < strlen($w); $i++) { if($w[$i] == 'G' && isset($_GET[$name])) return $_GET[$name]; if($w[$i] == 'P' && isset($_POST[$name])) return $_POST[$name]; if($w[$i] == 'C' && isset($_COOKIE[$name])) return $_COOKIE[$name]; } return $default; } } } $edition = 'zcore'; if($action=='doauth'){ $data = array( 'edition' => $edition, 'posturl' => $posturl, 'action' => $action, 'email' => $email, 'auth_code' => $auth_code, 'renew' => $renew, ); $host = 'www.google.com'; $script = 'authcode/checkauth.php'; $s = check_auth_code($data,$host,$script); if($s){ $arr = explode('|',$s); } if($arr[0]=='true'){ $handle = @fopen ("http://$host/authcode/".md5($email.'PD'.$auth_code).'.dat', "rb"); $contents = ""; do { $data = @fread($handle, 2048); if (strlen($data) == 0) { break; } $contents .= $data; } while(true); @fclose ($handle); make_dir(PHPDISK_ROOT.'system/global/'); file_put_contents(PHPDISK_ROOT.'system/global/cache_settings.inc.php',$contents); } exit($arr[1]); }elseif($action=='dotpl'){ $data = array( 'edition' => $edition, 'tpl_name' => $tpl_name, 'posturl' => $posturl, 'action' => $action, 'email' => $email, 'auth_code' => $auth_code, 'renew' => $renew, ); $host = 'www.google.com'; $script = 'authcode/check_auth_tpl.php'; $s = check_auth_code($data,$host,$script); if($s){ $arr = explode('|',$s); } if($arr[0]=='true'){ $handle = @fopen ("http://$host/authcode/".md5($email.'PDTPL'.$auth_code).'.tpl', "rb"); $contents = ""; do { $data = @fread($handle, 2048); if (strlen($data) == 0) { break; } $contents .= $data; } while(true); @fclose ($handle); if($contents){ $arrx = explode('|',$contents); $db->query_unbuffered("update {$tpf}templates set hash='{$arrx[2]}',actived=0,tpl_type='user' where tpl_name='{$arrx[1]}' limit 1"); $num = @$db->result_first("select count(*) from {$tpf}templates where actived=1 and tpl_type='user'"); if(!$num){ $db->query_unbuffered("update {$tpf}templates set actived=1 where tpl_name='default'"); } } } exit($arr[1]); } function check_auth_code($data,$host,$script,$port=80){ $url = 'http://'.$host.'/'.$script; if(!is_array($data)){ exit('No Data'); } if(function_exists('file_get_contents') && ini_get('allow_url_fopen')){ $context = array(); if (is_array($data)){ ksort($data); $context['http'] = array( 'method' => 'POST', 'content' => http_build_query($data), ); } return @file_get_contents($url, false, stream_context_create($context)); }else{ $fp = ''; $errno = 0; $errstr = ''; $timeout = 30; ksort($data); $post_str = http_build_query($data); $fp = fsockopen($host,$port,$errno,$errstr,$timeout); if (!$fp){ exit('fp fail'); } $content_length = strlen($post_str); $post_header = "POST $url HTTP/1.1\r\n"; $post_header .= "Content-Type: application/x-www-form-urlencoded\r\n"; $post_header .= "User-Agent: PHPDisk-Agent\r\n"; $post_header .= "Host: $host \r\n"; $post_header .= "Content-Length: ".$content_length."\r\n"; $post_header .= "Connection: close\r\n\r\n"; $post_header .= $post_str."\r\n\r\n"; fwrite($fp,$post_header); $inheader = true; $body = ''; while(!feof($fp)){ $line = fgets($fp,1024); if ($inheader && ($line == "\n" || $line == "\r\n")) { $inheader = false; } if (!$inheader && trim($line)) { $body .= $line; } } fclose($fp); unset ($line); $body = substr($body,2,strlen($body)); return $body; } } ?>